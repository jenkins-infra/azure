{
  "variables": {
        "azure_subscription_id" : "",
        "azure_client_id"       : "",
        "azure_client_secret"   : "",
        "azure_tenant_id"       : "",
        "azure_object_id": "{{env `PACKER_AZURE_OBJECT_ID`}}",
        "resource_group"        : "{{env `PACKER_IMAGE_RESOURCE_GROUP`}}",
        "storage_account"       : "{{env `PACKER_IMAGE_STORAGE_ACCOUNT`}}",
        "location"              : "{{env `PACKER_IMAGE_LOCATION` }}",
        "docker_images": "microsoft/windowsservercore microsoft/nanoserver",
        "docker_provider": "DockerProvider",
        "docker_version": "stable",
        "headless": "false"
  },
  "builders": [
    {
      "type": "azure-arm",

      "client_id": "{{user `azure_client_id`}}",
      "client_secret": "{{user `azure_client_secret`}}",
      "subscription_id": "{{user `azure_subscription_id`}}",
      "tenant_id" : "{{user `azure_tenant_id`}}",
      "object_id" : "{{ user `azure_object_id` }}",

      "communicator": "winrm",
      "capture_container_name": "windows",
      "capture_name_prefix": "docker-windows-2016",

      "image_offer": "WindowsServer",
      "image_publisher": "MicrosoftWindowsServer",
      "image_sku": "2016-Datacenter",
      "image_version": "latest",

      "location": "{{user `location` }}",
      "vm_size": "Standard_DS4_v2",

      "os_type": "Windows",

      "resource_group_name": "{{user `resource_group`}}",
      "storage_account": "{{user `storage_account`}}",

      "winrm_insecure": "true",
      "winrm_timeout": "3m",
      "winrm_use_ssl": "true",
      "winrm_username": "packer"
    }
  ],
  "post-processors": [],
  "provisioners": [
    {
      "scripts": [
        "./scripts/docker/2016/install-containers-feature.ps1"
      ],
      "type": "powershell"
    },
    {
      "type": "windows-restart"
    },
    {
      "environment_vars": [
        "docker_images={{user `docker_images`}}",
        "docker_provider={{user `docker_provider`}}",
        "docker_version={{user `docker_version`}}"
      ],
      "scripts": [
        "./scripts/docker/add-docker-group.ps1",
        "./scripts/docker/disable-windows-defender.ps1",
        "./scripts/docker/install-docker.ps1",
        "./scripts/docker/docker-pull.ps1",
        "./scripts/docker/remove-docker-key-json.ps1"
      ],
      "type": "powershell"
    }
  ]
}
